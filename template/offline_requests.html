<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Offline Payment Requests</title>
  <link rel="stylesheet" href="/staticfile/admin.css" />
  <style>
    .request-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
    }
    .request-table th, .request-table td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: left;
    }
    .request-table th {
      background-color: #f0860d;
      color: white;
    }
    .status-pending {
      color: orange;
    }
  </style>
</head>
<body>
  <section class="container">
    <h2>Offline Payment Requests</h2>

    <div class="filters">
        <input type="text" id="searchInput" placeholder="Search by email..." />
        <select id="statusFilter">
        <option value="">All</option>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
        </select>
    </div>

    <table>
        <thead>
        <tr>
            <th>Email</th>
            <th>Amount</th>
            <th>Plan</th>
            <th>Status</th>
            <th>Requested At</th>
        </tr>
        </thead>
        <tbody id="requestsBody"></tbody>
    </table>

    <div id="pagination"></div>
  </section>


  <script>
    const tbody = document.getElementById("requestsBody");
    const pagination = document.getElementById("pagination");
    const searchInput = document.getElementById("searchInput");
    const statusFilter = document.getElementById("statusFilter");

    let currentPage = 1;

    async function loadOfflineRequests(page = 1, search = "", status = "") {
    const res = await fetch(`/api/offline-requests?page=${page}&search=${encodeURIComponent(search)}&status=${encodeURIComponent(status)}`, {
        credentials: "include"
    });
    const data = await res.json();

    if (data.status !== "success") {
        tbody.innerHTML = "<tr><td colspan='5'>Failed to load data</td></tr>";
        return;
    }

    tbody.innerHTML = "";

    data.requests.forEach(req => {
        const row = document.createElement("tr");
        row.innerHTML = `
        <td>${req.email}</td>
        <td>₹${req.amount}</td>
        <td>${req.plan}</td>
        <td class="${req.status === 'pending' ? 'status-pending' : ''}">${req.status}</td>
        <td>${req.requestedAt}</td>
        `;
        tbody.appendChild(row);
    });

    renderPagination(data.page, data.total_pages);
    }

    function renderPagination(current, total) {
    pagination.innerHTML = "";
    for (let i = 1; i <= total; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        if (i === current) btn.disabled = true;
        btn.addEventListener("click", () => {
        currentPage = i;
        loadOfflineRequests(currentPage, searchInput.value, statusFilter.value);
        });
        pagination.appendChild(btn);
    }
    }

    searchInput.addEventListener("input", () => {
    loadOfflineRequests(1, searchInput.value, statusFilter.value);
    });

    statusFilter.addEventListener("change", () => {
    loadOfflineRequests(1, searchInput.value, statusFilter.value);
    });

    loadOfflineRequests(currentPage);


  </script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Offline Payment Requests</title>
  <link rel="stylesheet" href="/staticfile/admin.css" />
  <style>
    .request-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
    }
    .request-table th, .request-table td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: left;
    }
    .request-table th {
      background-color: #f0860d;
      color: white;
    }
    .status-pending {
      color: orange;
    }
    /* .action-btn {
      padding: 4px 10px;
      margin-right: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .approve-btn {
      background-color: #4caf50;
      color: white;
    }
    .reject-btn {
      background-color: #f44336;
      color: white;
    } */

    .action-btn {
    padding: 4px 10px;
    margin-right: 5px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    }
    .approve-btn {
    background-color: #4caf50;
    color: white;
    }
    .reject-btn {
    background-color: #f44336;
    color: white;
    }

  </style>
</head>
<body>
  <section class="container">
    <h2>Offline Payment Requests</h2>

    <div class="filters">
      <input type="text" id="searchInput" placeholder="Search by email..." />
      <select id="statusFilter">
        <option value="">All</option>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
      </select>
    </div>

    <table class="request-table">
      <thead>
        <tr>
          <th>Email</th>
          <th>Amount</th>
          <th>Plan</th>
          <th>Status</th>
          <th>Requested At</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="requestsBody"></tbody>
    </table>

    <div id="pagination"></div>
  </section>

  <script>
    const tbody = document.getElementById("requestsBody");
    const pagination = document.getElementById("pagination");
    const searchInput = document.getElementById("searchInput");
    const statusFilter = document.getElementById("statusFilter");

    let currentPage = 1;

    async function loadOfflineRequests(page = 1, search = "", status = "") {
      const res = await fetch(`/api/offline-requests?page=${page}&search=${encodeURIComponent(search)}&status=${encodeURIComponent(status)}`, {
        credentials: "include"
      });
      const data = await res.json();

      if (data.status !== "success") {
        tbody.innerHTML = "<tr><td colspan='6'>Failed to load data</td></tr>";
        return;
      }

      tbody.innerHTML = "";

      data.requests.forEach(req => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${req.email}</td>
          <td>₹${req.amount}</td>
          <td>${req.plan}</td>
          <td class="${req.status === 'pending' ? 'status-pending' : ''}">${req.status}</td>
          <td>${req.requestedAt}</td>
          <td>
            ${req.status === 'pending' ? `
              <button class="action-btn approve-btn" onclick="updateStatus('${req.user_id}', 'approved')">Approve</button>
              <button class="action-btn reject-btn" onclick="updateStatus('${req.user_id}', 'rejected')">Reject</button>
            ` : req.status.charAt(0).toUpperCase() + req.status.slice(1)}
          </td>
        `;
        tbody.appendChild(row);
      });

      renderPagination(data.page, data.total_pages);
    }

    function renderPagination(current, total) {
      pagination.innerHTML = "";
      for (let i = 1; i <= total; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        if (i === current) btn.disabled = true;
        btn.addEventListener("click", () => {
          currentPage = i;
          loadOfflineRequests(currentPage, searchInput.value, statusFilter.value);
        });
        pagination.appendChild(btn);
      }
    }

    async function updateStatus(id, status) {
        const action = status === 'approve' ? 'approve' : 'reject';
        const confirmMsg = `Are you sure you want to ${action} this request?`;
        if (!confirm(confirmMsg)) return;

        const res = await fetch('/admin/offline-request/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ user_id: id, action })
        });

        const result = await res.json();

        if (result.success === true) {
            alert(result.message || `Request ${action}d successfully.`);
            loadOfflineRequests(currentPage, searchInput.value, statusFilter.value);
        } else {
            alert(`Failed to ${action} request: ${result.detail || 'Unknown error'}`);
        }
    }





    // async function updateStatus(id, status) {
    //   const confirmMsg = `Are you sure you want to ${status} this request?`;
    //   if (!confirm(confirmMsg)) return;

    //   const res = await fetch('/admin/offline-request/update', {
    //     method: 'POST',
    //     headers: { 'Content-Type': 'application/json' },
    //     credentials: 'include',
    //     body: JSON.stringify({ id, status })
    //   });

    //   const result = await res.json();
    //   if (result.status === 'success') {
    //     alert(`Request ${status} successfully.`);
    //     loadOfflineRequests(currentPage, searchInput.value, statusFilter.value);
    //   } else {
    //     alert(`Failed to ${status} request: ${result.detail || 'Unknown error'}`);
    //   }
    // }

    searchInput.addEventListener("input", () => {
      loadOfflineRequests(1, searchInput.value, statusFilter.value);
    });

    statusFilter.addEventListener("change", () => {
      loadOfflineRequests(1, searchInput.value, statusFilter.value);
    });

    loadOfflineRequests(currentPage);
  </script>
</body>
</html>
